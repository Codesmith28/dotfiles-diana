---
- name: Install common graphics packages | {{ ansible_distribution }}
  community.general.pacman:
    name:
      - mesa
      - mesa-utils
    state: present
  become: true

- name: Install GPU drivers (AMD) | {{ ansible_distribution }}
  community.general.pacman:
    name:
      # https://wiki.archlinux.org/title/Xorg
      - xf86-video-amdgpu
      # https://wiki.archlinux.org/title/Hardware_video_acceleration
      - mesa-vdpau
      - libva-mesa-driver
      # https://wiki.archlinux.org/title/Vulkan
      - vulkan-radeon
      # https://wiki.archlinux.org/title/GPGPU
      - rocm-hip-runtime
      - rocm-hip-sdk
      - hip-runtime-amd
      - rocm-core
      - rocm-opencl-runtime
      - rocm-opencl-sdk
    state: present
  become: true
  when: "'amd' in gpu_result.stdout.lower() or 'radeon' in gpu_result.stdout.lower()"

- name: Install GPU drivers (Intel) | {{ ansible_distribution }}
  community.general.pacman:
    name:
      # https://wiki.archlinux.org/title/Xorg
      - xf86-video-intel
      # https://wiki.archlinux.org/title/Hardware_video_acceleration
      - intel-media-driver
      - libva-intel-driver
      # https://wiki.archlinux.org/title/Vulkan
      - vulkan-intel
      # https://wiki.archlinux.org/title/GPGPU
      - intel-compute-runtime
      - opencl-clover-mesa
    state: present
  become: true
  when: "'intel' in gpu_result.stdout.lower()"

- name: Install GPU drivers (Nvidia, proprietary, common) | {{ ansible_distribution }}
  community.general.pacman:
    name:
      # https://wiki.archlinux.org/title/NVIDIA
      - cuda
      - opencl-nvidia
    state: present
  become: true
  when: proprietary_nvidia_drivers

- name: Install GPU drivers (Nvidia, proprietary, modern) | {{ ansible_distribution }}
  community.general.pacman:
    name:
      # https://wiki.archlinux.org/title/NVIDIA
      - nvidia
      - nvidia-utils
    state: present
  become: true
  when:
    - new_nvidia
    - proprietary_nvidia_drivers

- name: Install GPU drivers (Nvidia, proprietary, legacy, Fermi) | {{ ansible_distribution }}
  kewlfft.aur.aur:
    name:
      # https://wiki.archlinux.org/title/NVIDIA
      - nvidia-390xx-dkms
    state: present
  become: false
  when:
    - not new_nvidia
    - proprietary_nvidia_drivers

- name: Install GPU drivers (Nvidia, Nouveau dependencies) | {{ ansible_distribution }}
  community.general.pacman:
    name:
      # https://wiki.archlinux.org/title/Nouveau
      - xf86-video-nouveau
      - vulkan-nouveau
    state: present
  become: true
  when:
    - not proprietary_nvidia_drivers
